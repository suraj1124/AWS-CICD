version: 0.2

phases:
  install:
    commands:
      - echo Installing dependencies...

      # Step 1: Configure Google Chrome repo
      - echo Adding Google Chrome repo...
      - sudo tee /etc/yum.repos.d/google-chrome.repo > /dev/null <<EOF
        [google-chrome]
        name=google-chrome
        baseurl=http://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled=1
        gpgcheck=1
        gpgkey=https://dl.google.com/linux/linux_signing_key.pub
        EOF

      # Step 2: Import GPG key
      - echo Importing GPG key...
      - wget https://dl.google.com/linux/linux_signing_key.pub
      - sudo rpm --import linux_signing_key.pub

      # Step 3: Now it's safe to update
      - echo Updating system packages...
      - sudo yum update -y

      # Step 4: Install Chrome
      - echo Installing Google Chrome...
      - sudo yum install -y google-chrome-stable
      - sudo yum install -y nginx zip
      - echo Checking if Nginx is installed...
      - nginx -v || echo "Nginx not found!"
      - echo Checking if Nginx service is running...
      - sudo systemctl status nginx || echo "Nginx service not running!"

  pre_build:
    commands:
      - echo Pre-build phase started
      - echo Copy index.html from GitHub to Nginx default directory
      - sudo cp v_1.2_CodeDeploy/index.html /var/www/html/
      - echo Verify index.html file exists in Nginx directory
      - ls /var/www/html/

  build:
    commands:
      - echo Build started on `date`
      - echo Creating zip artifact from Nginx directory
      - sudo zip -r artifact.zip /var/www/html/
      - echo Uploading artifact to S3 bucket
      - aws s3 cp artifact.zip s3://diyaorliya/liya/artifact.zip
      - echo Verifying upload
      - aws s3 ls s3://diyaorliya/liya/ --recursive

  post_build:
    commands:
      - echo Restarting Nginx to apply changes...
      - sudo systemctl restart nginx
      - echo Checking Nginx health...
      - curl -I http://localhost || echo "Nginx health check failed"

artifacts:
  files:
    - artifact.zip
